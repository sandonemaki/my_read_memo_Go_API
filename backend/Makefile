.PHONY: \
  goose-status \
  goose-up \
  goose-down \
  goose-create \
	goose-reset \
	golangci-lint \
	fmtcheck

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æŽ¥ç¶šæƒ…å ±
GOOSE_DRIVER=postgres
GOOSE_DBSTRING=postgres://yondeco:yondeco@localhost:5432/yondeco?sslmode=disable
MIGRATION_DIR=migration
SRCS = $(shell git ls-files '*.go')

define format
  go fmt ./... && goimports -w ./ && go mod tidy
endef

format:
	$(call format)

# Goose ã‚³ãƒžãƒ³ãƒ‰ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
GOOSE=goose -dir $(MIGRATION_DIR) $(GOOSE_DRIVER) "$(GOOSE_DBSTRING)"

goose-status:
	$(GOOSE) status
goose-up:
	$(GOOSE) up
goose-down:
	$(GOOSE) down
goose-create:
	@if [ -z "$(NAME)" ]; then \
		echo "NAME is required"; \
		exit 1; \
	fi; \
	$(GOOSE) create $(NAME) $(TYPE:=sql)
goose-reset:
	$(GOOSE) reset
golangci-lint:
	golangci-lint run --timeout=1h
fmtcheck:
	@ $(foreach file,$(SRCS),gofmt -s -l $(file);)
wire-gen-usecase:
	wire gen ./core/usecase
wire-gen-injector:
	wire gen ./core/injector

# ã‚¹ã‚­ãƒ¼ãƒžç¢ºèªã‚³ãƒžãƒ³ãƒ‰
schema-show:
	@echo "=== ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ ==="
	@psql "$(GOOSE_DBSTRING)" -c "\dt"
	@echo ""
	@echo "=== å…¨ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´° ==="
	@for table in $$(psql "$(GOOSE_DBSTRING)" -t -c "SELECT tablename FROM pg_tables WHERE schemaname='public' AND tablename != 'goose_db_version';"); do \
		echo "--- $$table ---"; \
		psql "$(GOOSE_DBSTRING)" -c "\d $$table"; \
		echo ""; \
	done

schema-dump:
	@echo "=== æœ€æ–°ã‚¹ã‚­ãƒ¼ãƒžæƒ…å ±ã‚’pkg/schema.txtã«å‡ºåŠ›ä¸­ ===" > pkg/schema.txt
	@echo "Generated at: $$(date '+%Y-%m-%d %H:%M:%S')" >> pkg/schema.txt
	@echo "Latest migration: $$(goose -dir migration postgres "$(GOOSE_DBSTRING)" status | tail -1 | awk '{print $$NF}')" >> pkg/schema.txt
	@echo "" >> pkg/schema.txt
	@echo "=== ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ ===" >> pkg/schema.txt
	@psql "$(GOOSE_DBSTRING)" -c "\dt" >> pkg/schema.txt 2>/dev/null
	@echo "" >> pkg/schema.txt
	@echo "=== å…¨ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´° ===" >> pkg/schema.txt
	@for table in $$(psql "$(GOOSE_DBSTRING)" -t -c "SELECT tablename FROM pg_tables WHERE schemaname='public' AND tablename != 'goose_db_version';"); do \
		echo "" >> pkg/schema.txt; \
		echo "--- $$table ---" >> pkg/schema.txt; \
		psql "$(GOOSE_DBSTRING)" -c "\d $$table" >> pkg/schema.txt 2>/dev/null; \
	done
	@echo ""
	@echo "âœ… Schema saved to pkg/schema.txt"

schema-simple:
	@echo "=== æœ€æ–°ã‚¹ã‚­ãƒ¼ãƒžä¸€è¦§ ==="
	@for table in $$(psql "$(GOOSE_DBSTRING)" -t -c "SELECT tablename FROM pg_tables WHERE schemaname='public' AND tablename != 'goose_db_version' ORDER BY tablename;"); do \
		echo ""; \
		echo "ðŸ“‹ Table: $$table"; \
		echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"; \
		psql "$(GOOSE_DBSTRING)" -c "SELECT column_name, data_type, is_nullable, column_default FROM information_schema.columns WHERE table_name='$$table' ORDER BY ordinal_position;" --quiet; \
	done
